{% comment %}
  Add-On Bundle Widget
  Displays configurable add-on products on product pages
{% endcomment %}

{% liquid
  comment
    For JSON metafields, .value returns the parsed object directly
    Try product-level first, then fall back to shop-level global config
  endcomment

  assign config = nil
  assign config_source = 'none'

  if product.metafields['addon-bundle']['config'] != blank
    assign config = product.metafields['addon-bundle']['config'].value
    assign config_source = 'product'
  elsif shop.metafields['addon-bundle']['global_config'] != blank
    assign config = shop.metafields['addon-bundle']['global_config'].value
    assign config_source = 'shop'
  endif

  comment
    Get widget style settings from config
  endcomment
  assign widget_style = config.style
  assign show_countdown = false
  if widget_style.showCountdownTimer == true and config.endDate != blank
    assign show_countdown = true
  endif
%}

{% if config != blank and config != empty %}

  <div
    class="addon-bundle-widget"
    data-bundle-id="{{ config.bundleId }}"
    data-product-id="{{ product.id }}"
    data-delete-addons-on-main-delete="{{ config.deleteAddonsOnMainDelete | default: false }}"
    {% if show_countdown %}
      data-end-date="{{ config.endDate }}"
    {% endif %}
    style="
      --addon-bg-color: {{ widget_style.backgroundColor | default: block.settings.background_color }};
      --addon-font-color: {{ widget_style.fontColor | default: block.settings.font_color }};
      --addon-button-color: {{ widget_style.buttonColor | default: block.settings.button_color }};
      --addon-button-text-color: {{ widget_style.buttonTextColor | default: block.settings.button_text_color }};
      --addon-badge-bg: {{ widget_style.discountBadgeColor | default: block.settings.badge_background }};
      --addon-badge-color: {{ widget_style.discountTextColor | default: block.settings.badge_text_color }};
      --addon-border-radius: {{ widget_style.borderRadius | default: block.settings.border_radius }}px;
      --addon-font-size: {{ widget_style.fontSize | default: block.settings.font_size }}px;
      --addon-title-font-size: {{ widget_style.titleFontSize | default: 18 }}px;
      --addon-subtitle-font-size: {{ widget_style.subtitleFontSize | default: 14 }}px;
      --addon-border-style: {{ widget_style.borderStyle | default: 'solid' | downcase }};
      --addon-border-width: {{ widget_style.borderWidth | default: 1 }}px;
      --addon-border-color: {{ widget_style.borderColor | default: '#e0e0e0' }};
      --addon-padding: {{ widget_style.padding | default: 16 }}px;
      --addon-margin-top: {{ widget_style.marginTop | default: 16 }}px;
      --addon-margin-bottom: {{ widget_style.marginBottom | default: 16 }}px;
    "
  >
    {% comment %} Bundle Title from config {% endcomment %}
    {% if config.title != blank %}
      <h3 class="addon-bundle-widget__title">{{ config.title }}</h3>
    {% endif %}

    {% comment %} Bundle Subtitle from config {% endcomment %}
    {% if config.subtitle != blank %}
      <p class="addon-bundle-widget__subtitle">{{ config.subtitle }}</p>
    {% endif %}

    {% comment %} Countdown Timer {% endcomment %}
    {% if show_countdown %}
      <div class="addon-bundle-widget__countdown" data-countdown-target="{{ config.endDate }}">
        <div class="addon-countdown">
          <div class="addon-countdown__item">
            <span class="addon-countdown__value" data-days>00</span>
            <span class="addon-countdown__label">Days</span>
          </div>
          <div class="addon-countdown__separator">:</div>
          <div class="addon-countdown__item">
            <span class="addon-countdown__value" data-hours>00</span>
            <span class="addon-countdown__label">Hours</span>
          </div>
          <div class="addon-countdown__separator">:</div>
          <div class="addon-countdown__item">
            <span class="addon-countdown__value" data-minutes>00</span>
            <span class="addon-countdown__label">Mins</span>
          </div>
          <div class="addon-countdown__separator">:</div>
          <div class="addon-countdown__item">
            <span class="addon-countdown__value" data-seconds>00</span>
            <span class="addon-countdown__label">Secs</span>
          </div>
        </div>
      </div>
    {% endif %}

    {% comment %} Product Groups with Tabs {% endcomment %}
    {% if config.productGroups != blank and config.productGroups.size > 1 %}
      {% render 'addon-tabs', groups: config.productGroups, selection_mode: config.selectionMode, image_size: widget_style.imageSize %}
    {% else %}
      {% comment %} Regular Add-On List {% endcomment %}
      <div class="addon-bundle-widget__list addon-bundle-widget__list--{{ widget_style.layoutType | default: 'LIST' | downcase }}">
        {% for addon in config.addOns %}
          {% render 'addon-item',
            addon: addon,
            selection_mode: config.selectionMode,
            image_size: widget_style.imageSize,
            show_quantity: addon.showQuantitySelector
          %}
        {% endfor %}
      </div>
    {% endif %}
  </div>

  {% comment %} Custom CSS from widget config {% endcomment %}
  {% if widget_style.customCss != blank %}
    <style>
      {{ widget_style.customCss }}
    </style>
  {% endif %}

  {% comment %} Custom JS from widget config {% endcomment %}
  {% if widget_style.customJs != blank %}
    <script>
      (function() {
        {{ widget_style.customJs }}
      })();
    </script>
  {% endif %}
{% endif %}

{% schema %}
{
  "name": "Product Add-Ons",
  "target": "section",
  "enabled_on": {
    "templates": ["product"]
  },
  "stylesheet": "addon-bundle.css",
  "javascript": "addon-bundle.js",
  "settings": [
    {
      "type": "header",
      "content": "Fallback Colors (used if not set in app)"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "font_color",
      "label": "Font color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "badge_background",
      "label": "Discount badge background",
      "default": "#e74c3c"
    },
    {
      "type": "color",
      "id": "badge_text_color",
      "label": "Discount badge text",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Fallback Spacing"
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 8,
      "unit": "px",
      "label": "Border radius"
    },
    {
      "type": "range",
      "id": "font_size",
      "min": 12,
      "max": 18,
      "step": 1,
      "default": 14,
      "unit": "px",
      "label": "Font size"
    }
  ]
}
{% endschema %}
