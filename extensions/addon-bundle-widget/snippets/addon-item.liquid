{% comment %}
  Add-On Item Snippet
  Renders a single add-on product with selection control

  Parameters:
  - addon: Object containing add-on data
  - selection_mode: 'SINGLE' or 'MULTIPLE'
  - image_size: 'small', 'medium', or 'large'
  - show_quantity: boolean
{% endcomment %}

{% liquid
  assign input_type = 'checkbox'
  if selection_mode == 'SINGLE'
    assign input_type = 'radio'
  endif

  assign image_dimension = 80
  case image_size
    when 'small'
      assign image_dimension = 50
    when 'large'
      assign image_dimension = 120
  endcase

  assign checked_attr = ''
  if addon.isDefaultSelected
    assign checked_attr = 'checked'
  endif

  assign variant_id = ''

  for variant in addon.selectedVariants limit:1
    if variant.shopifyVariantId != blank
      assign variant_id = variant.shopifyVariantId
      break
    endif
  endfor

  if variant_id == blank and addon.selectedVariants[0].shopifyVariantId != blank
    assign variant_id = addon.selectedVariants[0].shopifyVariantId
  endif

  if variant_id == blank and addon.selectedVariants.first.shopifyVariantId != blank
    assign variant_id = addon.selectedVariants.first.shopifyVariantId
  endif

  if variant_id == blank and addon.variantId != blank
    assign variant_id = addon.variantId
  endif

  if variant_id == blank and addon.shopifyVariantId != blank
    assign variant_id = addon.shopifyVariantId
  endif
%}

<!-- Debug: variant_id={{ variant_id }}, selectedVariants={{ addon.selectedVariants | json }}, size={{ addon.selectedVariants.size }} -->
<div class="addon-item" data-addon-id="{{ addon.addOnId }}" data-variant-id="{{ variant_id }}">
  <label class="addon-item__label">
    <input
      type="{{ input_type }}"
      name="addon_selection{% if selection_mode == 'SINGLE' %}_group{% endif %}"
      value="{{ addon.addOnId }}"
      class="addon-item__input"
      data-price="{{ addon.originalPrice }}"
      data-discount-type="{{ addon.discountType }}"
      data-discount-value="{{ addon.discountValue }}"
      {{ checked_attr }}
    >

    <span class="addon-item__checkbox-custom"></span>

    {% if addon.imageUrl != blank %}
      <img
        src="{{ addon.imageUrl | image_url: width: image_dimension }}"
        alt="{{ addon.productTitle }}"
        class="addon-item__image addon-item__image--{{ image_size }}"
        width="{{ image_dimension }}"
        height="{{ image_dimension }}"
        loading="lazy"
      >
    {% endif %}

    <span class="addon-item__content">
      <span class="addon-item__title">
        {{ addon.title | default: addon.productTitle }}
        {% if addon.discountLabel != blank %}
          <span class="addon-item__badge">{{ addon.discountLabel }}</span>
        {% elsif addon.discountType == 'FREE_GIFT' %}
          <span class="addon-item__badge addon-item__badge--free">{{ 'addon_bundle.free_gift' | t }}</span>
        {% elsif addon.discountValue != blank %}
          {% render 'addon-price', addon: addon %}
        {% endif %}
      </span>

      {% if addon.selectedVariants.size > 1 %}
        <select class="addon-item__variant-select" data-addon-id="{{ addon.addOnId }}">
          {% for variant in addon.selectedVariants %}
            <option value="{{ variant.shopifyVariantId }}" data-price="{{ variant.variantPrice }}">
              {{ variant.variantTitle }}
            </option>
          {% endfor %}
        </select>
      {% endif %}

      {% if show_quantity %}
        <span class="addon-item__quantity">
          <label class="addon-item__quantity-label" for="addon-qty-{{ addon.addOnId }}">
            {{ 'addon_bundle.quantity' | t }}:
          </label>
          <input
            type="number"
            id="addon-qty-{{ addon.addOnId }}"
            class="addon-item__quantity-input"
            value="1"
            min="1"
            max="{{ addon.maxQuantity | default: 10 }}"
          >
        </span>
      {% endif %}
    </span>
  </label>
</div>
